name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Run linter
        run: make lint

  vuln:
    name: Vulnerability Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Run vulnerability check
        run: make vuln

  test:
    name: Test (${{ matrix.container-runtime }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        container-runtime: [docker, podman]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Configure Podman
        if: matrix.container-runtime == 'podman'
        run: |
          # Enable Podman socket in rootful mode (k3s requires privileged containers)
          # Rootless Podman cannot properly run k3s due to cgroup permission issues
          sudo systemctl enable --now podman.socket

          # Set environment variables for testcontainers
          echo "DOCKER_HOST=unix:///run/podman/podman.sock" >> $GITHUB_ENV
          echo "TESTCONTAINERS_RYUK_DISABLED=true" >> $GITHUB_ENV

          # Verify Podman is working
          sudo podman version
          sudo podman info

      - name: Verify Container Runtime
        run: |
          if [ "${{ matrix.container-runtime }}" = "podman" ]; then
            sudo podman ps || exit 1
            echo "✓ Podman is configured and running (rootful mode)"
          else
            docker ps || exit 1
            echo "✓ Docker is configured and running"
          fi

      - name: Run tests
        run: make test
